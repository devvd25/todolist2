<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sender — Agent 10-18</title>
<style>
  /* style y hệt sender-left để giao diện giống nhau */
  body{font-family:Arial,Helvetica,sans-serif;margin:18px;background:#fafafa;color:#222}
  h1{margin-bottom:14px}
  .row{display:flex;align-items:center;gap:8px;padding:10px;border:1px solid #e6e6e6;border-radius:8px;background:#fff;margin-bottom:10px}
  .timer{width:70px;text-align:center;color:#666;font-size:13px}
  .row-number{width:34px;height:34px;border-radius:50%;background:#e9f6ff;color:#007bff;display:flex;align-items:center;justify-content:center;font-weight:700}
  .text-input{flex:1;padding:8px;border:1px solid #ddd;border-radius:6px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .note-input{width:140px;padding:8px;border:1px solid #ddd;border-radius:6px;resize:none;height:36px}
  .button{padding:7px 10px;border-radius:6px;border:none;color:#fff;cursor:pointer;font-size:13px}
  .paste-btn{background:#28a745}
  .send-btn{background:#17a2b8}
  .copy-btn{background:#007bff}
  .delete-btn{background:#dc3545}
  .paste-count,.copy-count{font-weight:700;color:#444;margin-left:6px}
  .copy-count.highlight{background:#ffc107;padding:4px 6px;border-radius:6px}
  .agent-select{width:110px;padding:6px;border-radius:6px;border:1px solid #ddd;background:#fff}
  .add-row-btn{margin-top:12px;padding:10px 16px;border-radius:6px;border:none;background:#28a745;color:#fff;cursor:pointer}
  .sent-label{margin-left:8px;padding:6px 8px;border-radius:6px;background:#28a745;color:#fff;font-weight:600}
</style>
</head>
<body>
  <h1>Sender — Agent 10 → 18</h1>
  <div id="rows"></div>
  <button class="add-row-btn" onclick="addRow()">Thêm hàng</button>

<script>
/* copy of left page logic but agent range is 10..18 */
const NGROK_URL = 'https://844aace9e015.ngrok-free.app/push'; // <-- thay bằng URL ngrok https của bạn
const SECRET_TOKEN = 'MY_SECRET_TOKEN_ChangeMe';
let rowData = [];
let pasteCounts = [];
let copyCounts = [];
let timers = [];
let uniqueLinks = [];

function ensureInitial(){ if(rowData.length===0){ rowData = Array(9).fill().map(()=>({text:'',note:''})); pasteCounts=Array(9).fill(0); copyCounts=Array(9).fill(0); timers=Array(9).fill(null);} }
function renderRows(){
  const container=document.getElementById('rows'); container.innerHTML='';
  rowData.forEach((d,idx)=>{
    const id=idx+1;
    const div=document.createElement('div'); div.className='row'; div.setAttribute('data-id',id);
    div.innerHTML = `
      <div class="timer"></div>
      <div class="row-number">${id}</div>
      <input class="text-input" value="${(d.text||'').replace(/"/g,'&quot;')}" placeholder="Nhập link hoặc văn bản...">
      <button class="button paste-btn" onclick="pasteText(${id})">Dán</button>
      <button class="button send-btn" onclick="sendToNgrok(${id})">Gửi</button>
      <button class="button copy-btn" onclick="copyText(${id})">Copy</button>
      <button class="button delete-btn" onclick="deleteText(${id})">Delete</button>
      <span class="paste-count">Dán: ${pasteCounts[idx]||0} lần</span>
      <span class="copy-count ${copyCounts[idx]>=5?'highlight':''}">Copy: ${copyCounts[idx]||0} lần</span>
      <select class="agent-select"></select>
      <textarea class="note-input" placeholder="Ghi chú...">${d.note||''}</textarea>
    `;
    container.appendChild(div);
    // populate agent-select with Agents 10..18
    const sel = div.querySelector('.agent-select');
    for(let a=10;a<=18;a++){ const o=document.createElement('option'); o.value=a; o.text='Agent '+a; sel.appendChild(o); }
    div.querySelector('.text-input').addEventListener('input', e=>{ rowData[idx].text = e.target.value; saveLocal(); });
    div.querySelector('.note-input').addEventListener('input', e=>{ rowData[idx].note = e.target.value; saveLocal(); });
  });
}
function addRow(){ rowData.push({text:'',note:''}); pasteCounts.push(0); copyCounts.push(0); timers.push(null); renderRows(); saveLocal(); }
function getKey(){ return 'sender_right_v1'; }
function saveLocal(){ localStorage.setItem(getKey(), JSON.stringify({rowData,pasteCounts,copyCounts,timers,uniqueLinks,ts:new Date().toISOString()})); }
function loadLocal(){ const raw=localStorage.getItem(getKey()); if(!raw) return; try{ const obj=JSON.parse(raw); if(obj.rowData){ rowData = obj.rowData; pasteCounts = obj.pasteCounts||[]; copyCounts = obj.copyCounts||[]; timers = obj.timers||[]; uniqueLinks = obj.uniqueLinks||[]; } }catch(e){ console.warn(e); } }

async function pasteText(rowId){ try{ const txt = await navigator.clipboard.readText(); rowData[rowId-1].text = txt; pasteCounts[rowId-1] = (pasteCounts[rowId-1]||0)+1; if(/^https?:\/\//i.test(txt.trim())){ if(!uniqueLinks.some(u=>u.url===txt.trim())) uniqueLinks.push({url:txt.trim(),timestamp:new Date().toISOString()}); } copyCounts[rowId-1] = (copyCounts[rowId-1]||0)+1; renderRows(); saveLocal(); }catch(e){ alert('Lỗi dán: '+e.message); } }
function copyText(rowId){ const val = rowData[rowId-1].text || ''; navigator.clipboard.writeText(val).then(()=>{ copyCounts[rowId-1] = (copyCounts[rowId-1]||0)+1; renderRows(); saveLocal(); }).catch(e=>alert('Lỗi copy: '+e.message)); }
function deleteText(rowId){ rowData[rowId-1]={text:'',note:''}; pasteCounts[rowId-1]=0; copyCounts[rowId-1]=0; renderRows(); saveLocal(); }

/* send */
async function sendToNgrok(rowId){
  const row = document.querySelector(`.row[data-id="${rowId}"]`);
  if(!row) return alert('Hàng không tồn tại');
  const link = (row.querySelector('.text-input').value||'').trim();
  const agentSel = row.querySelector('.agent-select');
  const agent = agentSel ? agentSel.value : '10';
  if(!link) return alert('Chưa có link để gửi');
  try{
    const payload = { token: SECRET_TOKEN, agent, link };
    const resp = await fetch(NGROK_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    if(!resp.ok){ const t=await resp.text().catch(()=>null); alert('Gửi thất bại: '+resp.status + (t?(' '+t):'')); return; }
    try{ await resp.json(); }catch(e){}
    let lbl = row.querySelector('.sent-label'); if(!lbl){ lbl=document.createElement('span'); lbl.className='sent-label'; row.appendChild(lbl); }
    lbl.textContent = `Đã gửi → Agent ${agent}`; setTimeout(()=>{ if(lbl) lbl.remove(); },1500);
  }catch(e){ alert('Lỗi gửi: '+e.message); }
}

/* init */
ensureInitial();
loadLocal();
renderRows();
</script>
</body>
</html>
